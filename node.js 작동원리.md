



#### node.js

- 자바스크립트 언어를 이용
- 고성능의 비동기 IO를 지원하는 네트워크 애플리케이션 개발 플랫폼
- Google의 Chrome `V8 자바스크립트 엔진`을 기본으로 동작
- `Single Thread` 기반의 `Event Loop(libuv)`가 돌면서 요청을 처리한다.
  - 시스템적으로 `non-blocking io`를 지원하지 않는 io 호출이 있는 경우, 비동기 처리 하기 위해 내부 `Thread pool(libio)`을 별도 이용하여 처리
- 네트워크 프로토콜을 처리하는 `socket, http` 바인딩 모듈이 로드
- 맨 윗단에 node.js에서 제공하는 standard library 로드
- **Disk, DB 접근이 많은 작업에 대해서는 유리하지 않다.**



![node.js server flow에 대한 이미지 검색결과](https://i.stack.imgur.com/QFatX.png)



#### 이벤트 루프

- 자바스크립트를 실행시키는 스레드는 단 하나뿐이며, 이 스레드가 이벤트 루프이다.
  - 메인스레드이며 싱글스레드이다.
- `blocking IO` 작업을 만나면 커널 비동기 또는 자신의 worker threadpool에 넘겨 준다.
- 이벤트 루프가 수행하는 작업
  - 라우터 기능
  - if 문 분기
  - 필터링
  - callback 내부 로직
- 이벤트 루프가 수행하지 않는 작업 (커널 비동기 또는 자신의 worker thread pool이 수행)
  - DB Query
  - 외부 API call
- **이벤트 루프가 수행하는 작업의 로직이 수행시간이 오래 걸리는 작업이라면 많은 요청을 처리하지 못함**
- 이벤트 루프가 blocking 되면 안된다.
  - ex) `while(true)`가 비즈니스 로직의 중간에 있을 때



#### 이벤트 루프의 작업 순서

```
   ┌───────────────────────────┐
┌─>│           timers          │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │     pending callbacks     │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
│  │       idle, prepare       │
│  └─────────────┬─────────────┘      ┌───────────────┐
│  ┌─────────────┴─────────────┐      │   incoming:   │
│  │           poll            │<─────┤  connections, │
│  └─────────────┬─────────────┘      │   data, etc.  │
│  ┌─────────────┴─────────────┐      └───────────────┘
│  │           check           │
│  └─────────────┬─────────────┘
│  ┌─────────────┴─────────────┐
└──┤      close callbacks      │
   └───────────────────────────┘
```

- 각 박스는 이벤트 루프의 단계를 의미
  - 각 단계는 실행할 콜백의 FIFO 큐를 가진다.
- 보통 이벤트 루프가 해당 단계에 진입하면 해당 단계에 한정된 작업을 수행하고 큐를 모두 소진하거나 콜백의 최대 개수를 실행할 때까지 해당 단계의 큐에서 콜백을 실행 
  - 큐를 모두 소진하거나 콜백 제한에 이르면 이벤트 루프는 다음 단계로 이동.
  - 다른 작업을 스케줄링하거나 **poll** 단계에서 처리된 새로운 이벤트가 커널에 의해 큐에 추가될 수 있으므로 폴링 이벤트를 처리하면서 poll 이벤트를 큐에 추가할 수 있다. 
  - 그 결과 오래 실행되는 콜백은 poll 단계가 타이머의 한계 시점보다 훨씬 더 오래 실행되도록 할 수 있다.



#### libuv

- node.js에 **이벤트루프를 제공하는 라이브러리**
- 윈도우 커널, 리눅스 커널을 추상화해서 wrapping 하고 있다.
- node.js는 기본적으로 libuv 위에서 동작
  - node 인스턴스가 생성 되면, libuv에는 worker thread pool(기본 4개)이 생성된다.
- 가능한 직접 OS의 비동기 Interface를 사용하며, thread pool에 작업을 넘겨주지 않는다.
  - DB 접속도 DB 드라이버를 이용해 스레드풀을 활용하지 않고, 비동기 인터페이스를 직접 사용
  - 다른 방법이 없을 경우, libuv는 비동기 작업들을 thread pool에 할당

---

#### 출처

- https://yonghyunlee.gitlab.io/node/nodejs-structure/
- https://sjh836.tistory.com/149
- https://tk-one.github.io/2019/02/07/nodejs-event-loop/

- https://nodejs.org/ko/docs/guides/event-loop-timers-and-nexttick/